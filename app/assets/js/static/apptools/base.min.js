(function(){var AppException,AppTools,AppToolsCollection,AppToolsException,AppToolsModel,AppToolsRouter,AppToolsView,CoreAPI,CoreAgentAPI,CoreDevAPI,CoreDispatchAPI,CoreEventsAPI,CoreException,CoreInterface,CoreModelAPI,CoreObject,CorePushAPI,CoreRPCAPI,CoreRenderAPI,CoreStorageAPI,CoreUserAPI,Expand,Find,IndexedDBDriver,IndexedDBEngine,KeyEncoder,LocalStorageDriver,LocalStorageEngine,Milk,Model,ModelException,Parse,PushDriver,QueryDriver,RPCAPI,RPCDriver,RPCRequest,RPCResponse,RenderDriver,SessionStorageDriver,SessionStorageEngine,SimpleKeyEncoder,StorageAdapter,StorageDriver,Template,TemplateCache,Util,WebSQLDriver,WebSQLEngine,_simple_key_encoder,__slice=Array.prototype.slice,__hasProp=Object.prototype.hasOwnProperty,__extends=function(child,parent){for(var key in parent)__hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},__bind=function(fn,me){return function(){return fn.apply(me,arguments)}},__indexOf=Array.prototype.indexOf||function(item){for(var i=0,l=this.length;i<l;i++)if(i in this&&this[i]===item)return i;return-1},_this=this;this.__apptools_preinit={},TemplateCache={},Find=function(name,stack,value){var ctx,i,part,parts,_i,_len,_ref,_ref2;value==null&&(value=null);if(name===".")return stack[stack.length-1];_ref=name.split(/\./),name=_ref[0],parts=2<=_ref.length?__slice.call(_ref,1):[];for(i=_ref2=stack.length-1;_ref2<=-1?i<-1:i>-1;_ref2<=-1?i++:i--){if(stack[i]==null)continue;if(typeof stack[i]=="object"&&name in(ctx=stack[i])){value=ctx[name];break}continue}for(_i=0,_len=parts.length;_i<_len;_i++)part=parts[_i],value=Find(part,[value]);return value instanceof Function&&(value=function(value){return function(){var val;return val=value.apply(ctx,arguments),val instanceof Function&&val.apply(null,arguments)||val}}(value)),value},Expand=function(){var args,f,obj,tmpl;return obj=arguments[0],tmpl=arguments[1],args=3<=arguments.length?__slice.call(arguments,2):[],function(){var _i,_len,_results;_results=[];for(_i=0,_len=tmpl.length;_i<_len;_i++)f=tmpl[_i],_results.push(f.call.apply(f,[obj].concat(__slice.call(args))));return _results}().join("")},Parse=function(template,delimiters,section){var BuildRegex,buffer,buildInterpolationTag,buildInvertedSectionTag,buildPartialTag,buildSectionTag,cache,content,contentEnd,d,error,escape,isStandalone,match,name,parseError,pos,sectionInfo,tag,tagPattern,tmpl,type,whitespace,_name,_ref,_ref2,_ref3;delimiters==null&&(delimiters=["{{","}}"]),section==null&&(section=null),cache=TemplateCache[_name=delimiters.join(" ")]||(TemplateCache[_name]={});if(template in cache)return cache[template];buffer=[],BuildRegex=function(){var tagClose,tagOpen;return tagOpen=delimiters[0],tagClose=delimiters[1],RegExp("([\\s\\S]*?)([ \\t]*)(?:"+tagOpen+"\\s*(?:(!)\\s*([\\s\\S]+?)|(=)\\s*([\\s\\S]+?)\\s*=|({)\\s*(\\w[\\S]*?)\\s*}|([^0-9a-zA-Z._!={]?)\\s*([\\w.][\\S]*?))\\s*"+tagClose+")","gm")},tagPattern=BuildRegex(),tagPattern.lastIndex=pos=(section||{start:0}).start,parseError=function(pos,msg){var carets,e,endOfLine,error,indent,key,lastLine,lastTag,lineNo,parsedLines,tagStart;(endOfLine=/$/gm).lastIndex=pos,endOfLine.exec(template),parsedLines=template.substr(0,pos).split("\n"),lineNo=parsedLines.length,lastLine=parsedLines[lineNo-1],tagStart=contentEnd+whitespace.length,lastTag=template.substr(tagStart+1,pos-tagStart-1),indent=(new Array(lastLine.length-lastTag.length+1)).join(" "),carets=(new Array(lastTag.length+1)).join("^"),lastLine+=template.substr(pos,endOfLine.lastIndex-pos),error=new Error;for(key in e={message:""+msg+"\n\nLine "+lineNo+":\n"+lastLine+"\n"+indent+carets,error:msg,line:lineNo,"char":indent.length,tag:lastTag})error[key]=e[key];return error};while(match=tagPattern.exec(template)){_ref=match.slice(1,3),content=_ref[0],whitespace=_ref[1],type=match[3]||match[5]||match[7]||match[9],tag=match[4]||match[6]||match[8]||match[10],contentEnd=pos+content.length-1,pos=tagPattern.lastIndex,isStandalone=(contentEnd===-1||template.charAt(contentEnd)==="\n")&&((_ref2=template.charAt(pos))===void 0||_ref2===""||_ref2==="\r"||_ref2==="\n"),content&&buffer.push(function(content){return function(){return content}}(content)),isStandalone&&type!==""&&type!=="&"&&type!=="{"?(template.charAt(pos)==="\r"&&(pos+=1),template.charAt(pos)==="\n"&&(pos+=1)):whitespace&&(buffer.push(function(whitespace){return function(){return whitespace}}(whitespace)),contentEnd+=whitespace.length,whitespace="");switch(type){case"!":break;case"":case"&":case"{":buildInterpolationTag=function(name,is_unescaped){return function(context){var value,_ref3;return(value=(_ref3=Find(name,context))!=null?_ref3:"")instanceof Function&&(value=Expand.apply(null,[this,Parse(""+value())].concat(__slice.call(arguments)))),is_unescaped||(value=this.escape(""+value)),""+value}},buffer.push(buildInterpolationTag(tag,type));break;case">":buildPartialTag=function(name,indentation){return function(context,partials){var partial;return partial=partials(name).toString(),indentation&&(partial=partial.replace(/^(?=.)/gm,indentation)),Expand.apply(null,[this,Parse(partial)].concat(__slice.call(arguments)))}},buffer.push(buildPartialTag(tag,whitespace));break;case"#":case"^":sectionInfo={name:tag,start:pos,error:parseError(tagPattern.lastIndex,"Unclosed section '"+tag+"'!")},_ref3=Parse(template,delimiters,sectionInfo),tmpl=_ref3[0],pos=_ref3[1],sectionInfo["#"]=buildSectionTag=function(name,delims,raw){return function(context){var parsed,result,v,value;return value=Find(name,context)||[],tmpl=value instanceof Function?value(raw):raw,value instanceof Array||(value=[value]),parsed=Parse(tmpl||"",delims),context.push(value),result=function(){var _i,_len,_results;_results=[];for(_i=0,_len=value.length;_i<_len;_i++)v=value[_i],context[context.length-1]=v,_results.push(Expand.apply(null,[this,parsed].concat(__slice.call(arguments))));return _results}.apply(this,arguments),context.pop(),result.join("")}},sectionInfo["^"]=buildInvertedSectionTag=function(name,delims,raw){return function(context){var value;return value=Find(name,context)||[],value instanceof Array||(value=[1]),value=value.length===0?Parse(raw,delims):[],Expand.apply(null,[this,value].concat(__slice.call(arguments)))}},buffer.push(sectionInfo[type](tag,delimiters,tmpl));break;case"/":section==null?error="End Section tag '"+tag+"' found, but not in section!":tag!==(name=section.name)&&(error="End Section tag closes '"+tag+"'; expected '"+name+"'!");if(error)throw parseError(tagPattern.lastIndex,error);return template=template.slice(section.start,contentEnd+1||9e9),cache[template]=buffer,[template,pos];case"=":(delimiters=tag.split(/\s+/)).length!==2&&(error="Set Delimiters tags should have two and only two values!");if(error)throw parseError(tagPattern.lastIndex,error);escape=/[-[\]{}()*+?.,\\^$|#]/g,delimiters=function(){var _i,_len,_results;_results=[];for(_i=0,_len=delimiters.length;_i<_len;_i++)d=delimiters[_i],_results.push(d.replace(escape,"\\$&"));return _results}(),tagPattern=BuildRegex();break;default:throw parseError(tagPattern.lastIndex,"Unknown tag type -- "+type)}tagPattern.lastIndex=pos!=null?pos:template.length}if(section!=null)throw section.error;return template.length!==pos&&buffer.push(function(){return template.slice(pos)}),cache[template]=buffer},Milk={VERSION:"1.2.0",helpers:[],partials:null,escape:function(value){var entities;return entities={"&":"amp",'"':"quot","<":"lt",">":"gt"},value.replace(/[&"<>]/g,function(ch){return"&"+entities[ch]+";"})},render:function(template,data,partials){var context;return partials==null&&(partials=null),(partials||(partials=this.partials||{}))instanceof Function||(partials=function(partials){return function(name){if(name in partials)return Find(name,[partials]);throw"Unknown partial '"+name+"'!"}}(partials)),context=this.helpers instanceof Array?this.helpers:[this.helpers],Expand(this,Parse(template),context.concat([data]),partials)}},this.__apptools_preinit!=null?(this.__apptools_preinit.abstract_base_classes=[],this.__apptools_preinit.deferred_core_modules=[],this.__apptools_preinit.abstract_feature_interfaces=[],this.__apptools_preinit.deferred_library_integrations=[]):this.__apptools_preinit={abstract_base_classes:[],deferred_core_modules:[],abstract_feature_interfaces:[],deferred_library_integrations:[]},CoreAPI=function(){function CoreAPI(){}return CoreAPI}(),this.__apptools_preinit.abstract_base_classes.push(CoreAPI),CoreObject=function(){function CoreObject(){}return CoreObject}(),this.__apptools_preinit.abstract_base_classes.push(CoreObject),CoreInterface=function(){function CoreInterface(){}return CoreInterface}(),this.__apptools_preinit.abstract_base_classes.push(CoreInterface),CoreException=function(_super){__extends(CoreException,_super);function CoreException(module,message,context){this.module=module,this.message=message,this.context=context}return CoreException.prototype.toString=function(){return"["+this.module+"] CoreException: "+this.message},CoreException}(Error),this.__apptools_preinit.abstract_base_classes.push(CoreException),AppException=function(_super){__extends(AppException,_super);function AppException(){AppException.__super__.constructor.apply(this,arguments)}return AppException.prototype.toString=function(){return"["+this.module+"] AppException: "+this.message},AppException}(CoreException),AppToolsException=function(_super){__extends(AppToolsException,_super);function AppToolsException(){AppToolsException.__super__.constructor.apply(this,arguments)}return AppToolsException.prototype.toString=function(){return"["+this.module+"] AppToolsException: "+this.message},AppToolsException}(CoreException),this.__apptools_preinit.abstract_base_classes.push(AppException),this.__apptools_preinit.abstract_base_classes.push(AppToolsException),this.Backbone!=null?(AppToolsView=function(_super){__extends(AppToolsView,_super);function AppToolsView(){AppToolsView.__super__.constructor.apply(this,arguments)}return AppToolsView}(Backbone.View),AppToolsModel=function(_super){__extends(AppToolsModel,_super);function AppToolsModel(){AppToolsModel.__super__.constructor.apply(this,arguments)}return AppToolsModel}(Backbone.Model),AppToolsRouter=function(_super){__extends(AppToolsRouter,_super);function AppToolsRouter(){AppToolsRouter.__super__.constructor.apply(this,arguments)}return AppToolsRouter}(Backbone.Router),AppToolsCollection=function(_super){__extends(AppToolsCollection,_super);function AppToolsCollection(){AppToolsCollection.__super__.constructor.apply(this,arguments)}return AppToolsCollection}(Backbone.Collection)):(AppToolsView=function(){function AppToolsView(){}return AppToolsView}(),AppToolsModel=function(){function AppToolsModel(){}return AppToolsModel}(),AppToolsRouter=function(){function AppToolsRouter(){}return AppToolsRouter}(),AppToolsCollection=function(){function AppToolsCollection(){}return AppToolsCollection}()),this.__apptools_preinit.abstract_base_classes.push(AppToolsView),this.__apptools_preinit.abstract_base_classes.push(AppToolsModel),this.__apptools_preinit.abstract_base_classes.push(AppToolsRouter),this.__apptools_preinit.abstract_base_classes.push(AppToolsCollection),Util=function(){var _this=this;Util.mount="util",Util.events=[],Util.prototype.is=function(thing){return!this.in_array(thing,[!1,null,NaN,void 0,0,{},[],"","false","False","null","NaN","undefined","0","none","None"])},Util.prototype.is_function=function(object){return typeof object=="function"},Util.prototype.is_object=function(object){return typeof object=="object"},Util.prototype.is_raw_object=function(object){return!object||typeof object!="object"||object.nodeType||typeof object=="object"&&__indexOf.call(object,"setInterval")>=0?!1:object.constructor!=null&&!object.hasOwnProperty("constructor")&&!object.constructor.prototype.hasOwnProperty("isPrototypeOf")?!1:!0},Util.prototype.is_empty_object=function(object){var key;for(key in object)return!1;return!0},Util.prototype.is_body=function(object){return this.is_object(object)&&(Object.prototype.toString.call(object)==="[object HTMLBodyElement]"||object.constructor.name==="HTMLBodyElement")},Util.prototype.is_array=Array.isArray||function(object){return typeof object=="array"||Object.prototype.toString.call(object)==="[object Array]"||object.constructor.name==="Array"},Util.prototype.in_array=function(item,array){var it,matches,_fn,_i,_len,_this=this;if(array.indexOf!=null)return!!~array.indexOf(item);matches=[],_fn=function(it){if(it===item)return matches.push(it)};for(_i=0,_len=array.length;_i<_len;_i++)it=array[_i],_fn(it);return matches.length>0},Util.prototype.to_array=function(node_or_token_list){var array;array=[];for(i=node_or_token_list.length;i--;array.unshift(node_or_token_list[i]));return array},Util.prototype.filter=function(array,condition){var item,new_array,_i,_len;new_array=[];for(_i=0,_len=array.length;_i<_len;_i++)item=array[_i],condition(item)&&new_array.push(item);return new_array},Util.prototype.sort=null,Util.prototype.create_element_string=function(tag,attrs,separator,ext){var el_str,k,no_close,v;separator==null&&(separator="*"),no_close=["area","base","basefont","br","col","frame","hr","img","input","link"],tag=tag.toLowerCase(),el_str="<"+tag;for(k in attrs)v=attrs[k],el_str+=" "+k+'="'+v+'"';return ext!=null&&(el_str+=" "+ext),el_str+=">",this.in_array(tag,no_close)||(el_str+=separator+"</"+tag+">"),el_str},Util.prototype.create_doc_frag=function(html_string){var frag,range;return range=document.createRange(),range.selectNode(document.getElementsByTagName("div").item(0)),frag=range.createContextualFragment(html_string),frag},Util.prototype.add=function(element_type,attrs,parent_node){var node_id,q_name,_this=this;return element_type==null||!this.is_object(attrs)?!1:(q_name=this.is_body(parent_node)||parent_node==null||!(node_id=parent_node.getAttribute("id"))?"dom":node_id,this._state.queues[q_name]==null&&this.internal.queues.add(q_name),this._state.queues[q_name].push([element_type,attrs]),this.internal.queues.go(q_name,function(response){var args,dfrag,html,parent,q,_i,_len;q=response.queue,parent=response.name==="dom"?document.body:_this.get(response.name),html=[];for(_i=0,_len=q.length;_i<_len;_i++)args=q[_i],html.push(_this.create_element_string.apply(_this,args));return dfrag=_this.create_doc_frag(html.join("")),parent.appendChild(dfrag)}))},Util.prototype.remove=function(node){return node.parentNode.removeChild(node)},Util.prototype.get=function(query,node){var cls,id,tg;return node==null&&(node=document),query==null?null:query.nodeType?query:(id=document.getElementById(query))!=null?id:(cls=node.getElementsByClassName(query)).length>0?this.to_array(cls):(tg=node.getElementsByTagName(query)).length>0?this.to_array(tg):null},Util.prototype.get_offset=function(elem){var offL,offT;offL=offT=0;for(;;){offL+=elem.offsetLeft,offT+=elem.offsetTop;if(!(elem=elem.offsetParent))break}return{left:offL,top:offT}},Util.prototype.has_class=function(element,cls){var _ref;return((_ref=element.classList)!=null?typeof _ref.contains=="function"?_ref.contains(cls):void 0:void 0)||element.className&&(new RegExp("\\s*"+cls+"\\s*")).test(element.className)},Util.prototype.is_id=function(str){return str.charAt(0)==="#"?!0:document.getElementById(str)!==null?!0:!1},Util.prototype.bind=function(element,event,fn,prop){var el,ev,evt,func,_i,_j,_len,_len2;prop==null&&(prop=!1);if(element==null)return!1;if(this.is_array(element))for(_i=0,_len=element.length;_i<_len;_i++)el=element[_i],this.bind(el,event,fn,prop);else if(this.is_array(event))for(_j=0,_len2=event.length;_j<_len2;_j++)evt=event[_j],this.bind(element,evt,fn,prop);else{if(!this.is_raw_object(event))return element.addEventListener(event,fn,prop);for(ev in event)func=event[ev],this.bind(element,ev,func,prop)}},Util.prototype.unbind=function(element,event){var el,ev,_i,_j,_len,_len2;if(element==null)return!1;if(this.is_array(element))for(_i=0,_len=element.length;_i<_len;_i++)el=element[_i],this.unbind(el,event);else if(this.is_array(event))for(_j=0,_len2=event.length;_j<_len2;_j++)ev=event[_j],this.unbind(element,ev);else{if(!this.is_raw_object(element))return element.constructor.name==="NodeList"?this.unbind(this.to_array(element),event):element.removeEventListener(event);for(el in element)ev=element[el],this.unbind(el,ev)}},Util.prototype.block=function(async_method,object){var result,_done;object==null&&(object={}),console.log("[Util] Enforcing blocking at user request... :("),_done=!1,result=null,async_method(object,function(x){return result=x,_done=!0});for(;;)if(_done!==!1)break;return result},Util.prototype.now=function(){return+(new Date)},Util.prototype.timestamp=function(d){return d==null&&(d=new Date),[[d.getMonth()+1,d.getDate(),d.getFullYear()].join("-"),[d.getHours(),d.getMinutes(),d.getSeconds()].join(":")].join(" ")},Util.prototype.prep_animation=function(t,e,c){var options;return options=t==null?{duration:400}:t!=null&&this.is_object(t)?this.extend({},t):{complete:c||!c&&e||is_function(t&&t),duration:t,easing:c&&e||e&&!is_function(e)},options},Util.prototype.throttle=function(fn,buffer,prefire){var last,timer_id,_this=this;return timer_id=null,last=0,function(){var args,clear,elapsed,go;return args=arguments,elapsed=_this.now()-last,clear=function(){return go(),timer_id=null},go=function(){return last=_this.now(),fn.apply(_this,args)},prefire&&!timer_id&&go(),!timer_id||clearTimeout(timer_id),prefire==null&&elapsed>=buffer?go():timer_id=setTimeout(prefire?clear:go,prefire==null?buffer-elapsed:buffer)}},Util.prototype.debounce=function(fn,buffer,prefire){return buffer==null&&(buffer=200),prefire==null&&(prefire=!1),this.throttle(fn,buffer,prefire)},Util.prototype.currency=function(num){var char,index,len,new_nums,nums,process,_len,_this=this;len=(nums=String(num).split("").reverse()).length,new_nums=[],process=function(c,i){var sym;return(i+1)%3===0&&len-i>1?sym=",":i===len-1?sym="$":sym="",new_nums.unshift(sym+c)};for(index=0,_len=nums.length;index<_len;index++)char=nums[index],process(char,index);return new_nums.join("")},Util.prototype.extend=function(){var arg,args,deep,i,len,target,_fn,_i,_len,_this=this;target=arguments[0]||{},i=1,deep=!1,len=arguments.length,typeof target=="boolean"&&(deep=target,target=arguments[1]||{},i++),!this.is_object(target)&&!this.is_function(target)&&(target={}),args=Array.prototype.slice.call(arguments,i),_fn=function(arg){var a,clone,copied_src,o,option,options,src,value,_results;options=arg,_results=[];for(option in options){if(!__hasProp.call(options,option))continue;value=options[option];if(target===value)continue;o=String(option),clone=value,src=target[option],deep&&clone!=null&&(_this.is_raw_object(clone)||(a=_this.is_array(clone)))?(a!=null?(a=!1,copied_src=src&&(_this.is_array(src)?src:[])):copied_src=src&&(_this.is_raw_object(src)?src:{}),_results.push(target[option]=_this.extend(deep,copied_src,clone))):clone!=null?_results.push(target[option]=clone):_results.push(void 0)}return _results};for(_i=0,_len=args.length;_i<_len;_i++)arg=args[_i],_fn(arg);return target},Util.prototype.to_hex=function(color){var b,c,g,r;if(color.match(/^#?[0-9a-fA-F]{6}|[0-9a-fA-F]{3}$\/i/))return color.charAt(!1)?color:"#"+color;if(!color.match(/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/))return!1;c=[parseInt(RegExp.$1,10),parseInt(RegExp.$2,10),parseInt(RegExp.$3,10)];if(c.length===3)return r=this.zero_fill(c[0].toString(16,2)),g=this.zero_fill(c[1].toString(16,2)),b=this.zero_fill(c[2].toString(16,2)),"#"+r+g+b},Util.prototype.to_rgb=function(color){var b,c,g,r;return color.match(/^rgb\(\s*\d{1,3}\s*,\s\d{1,3}\s*,\s*\d{1,3}\s*\)$/)?color:color.match(/^#?([0-9a-fA-F]{1,2})([0-9a-fA-F]{1,2})([0-9a-fA-F]{1,2})$\/i/)?(c=[parseInt(RegExp.$1,16),parseInt(RegExp.$2,16),parseInt(RegExp.$3,16)],r=c[0].toString(10),g=c[1].toString(10),b=c[2].toString(10),"rgb("+r+","+g+","+b+")"):!1},Util.prototype.strip_script=function(link){var script;return link.match(/^javascript:(\w\W.)/||link.match(/(\w\W.)\(\)/))?(script=RegExp.$1,console.log("Script stripped from link: ",script),"javascript:void(0)"):link},Util.prototype.wrap=function(e,fn){var args,i;return i=2,e.preventDefault!=null?(e.preventDefault(),e.stopPropagation()):(fn=e,i--),args=Array.prototype.slice.call(arguments,i),function(){return fn.apply(this,args)}},Util.prototype.zero_fill=function(num,length){return(Array(length).join("0")+num).slice(-length)};function Util(){this.zero_fill=__bind(this.zero_fill,this),this.strip_script=__bind(this.strip_script,this),this.to_rgb=__bind(this.to_rgb,this),this.to_hex=__bind(this.to_hex,this),this.extend=__bind(this.extend,this),this.currency=__bind(this.currency,this),this.throttle=__bind(this.throttle,this),this.prep_animation=__bind(this.prep_animation,this),this.timestamp=__bind(this.timestamp,this),this.now=__bind(this.now,this),this.block=__bind(this.block,this),this.unbind=__bind(this.unbind,this),this.bind=__bind(this.bind,this),this.is_id=__bind(this.is_id,this),this.has_class=__bind(this.has_class,this),this.get_offset=__bind(this.get_offset,this),this.get=__bind(this.get,this),this.remove=__bind(this.remove,this),this.add=__bind(this.add,this),this.create_doc_frag=__bind(this.create_doc_frag,this),this.create_element_string=__bind(this.create_element_string,this),this.filter=__bind(this.filter,this),this.to_array=__bind(this.to_array,this),this.in_array=__bind(this.in_array,this),this.is_body=__bind(this.is_body,this),this.is_empty_object=__bind(this.is_empty_object,this),this.is_raw_object=__bind(this.is_raw_object,this),this.is_object=__bind(this.is_object,this),this.is_function=__bind(this.is_function,this),this.is=__bind(this.is,this);var _this=this;this._state={active:null,queues:{fx:[],dom:[],handlers:{}}},this.internal={queues:{add:function(name,callback){return _this._state.queues[name]=[],_this._state.queues.handlers[name]=_this.debounce(function(n,c){return _this.internal.queues.process(n,c)},_this.prep_animation().duration,!0)},remove:function(name,callback){var handler,q;return handler=_this._state.queues.handlers[name],delete _this._state.queues.handlers[name],q=_this._state.queues[name],delete _this._state.queues[name],q.length>0?{queue:q,handler:handler}:!0},go:function(name,callback){return _this._state.queues.handlers[name](name,callback)},process:function(name,callback){var q;return q=_this._state.queues[name],_this._state.queues[name]=[],callback!=null?callback.call(_this,{queue:q,name:name}):void 0}}},this._init=function(apptools){}}return Util}.call(this),this.__apptools_preinit.abstract_base_classes.push(Util),this.__apptools_preinit.deferred_core_modules.push({module:Util}),window.Util=Util=new Util,CoreDevAPI=function(_super){__extends(CoreDevAPI,_super),CoreDevAPI.mount="dev",CoreDevAPI.events=[];function CoreDevAPI(apptools,window){var _this=this;this.config={},this.environment={},this.performance={},this.debug={logging:!0,eventlog:!0,verbose:!0,serverside:!1},this.setDebug=function(debug){return _this.debug=debug,_this._sendLog("[CoreDev] Debug has been set.",_this.debug)},this._sendLog=function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],console.log.apply(console,args)},this.log=function(){var context,message,module;module=arguments[0],message=arguments[1],context=3<=arguments.length?__slice.call(arguments,2):[],context==null&&(context="{no context}"),_this.debug.logging===!0&&_this._sendLog.apply(_this,["["+module+"] INFO: "+message].concat(__slice.call(context)))},this.warning=this.warn=function(){var context,message,module;module=arguments[0],message=arguments[1],context=3<=arguments.length?__slice.call(arguments,2):[],context==null&&(context="{no context}"),_this.debug.logging===!0&&_this._sendLog.apply(_this,["["+module+"] WARNING: "+message].concat(__slice.call(context)))},this.error=function(){var context,message,module;module=arguments[0],message=arguments[1],context=3<=arguments.length?__slice.call(arguments,2):[],_this.debug.logging===!0&&_this._sendLog.apply(_this,["["+module+"] ERROR: "+message].concat(__slice.call(context)))},this.verbose=function(){var context,message,module;module=arguments[0],message=arguments[1],context=3<=arguments.length?__slice.call(arguments,2):[],_this.debug.verbose===!0&&_this._sendLog.apply(_this,["["+module+"] DEBUG: "+message].concat(__slice.call(context)))},this.exception=this.critical=function(){var context,exception,message,module;throw module=arguments[0],message=arguments[1],exception=arguments[2],context=4<=arguments.length?__slice.call(arguments,3):[],exception==null&&(exception=window.AppToolsException),_this._sendLog("A critical error or unhandled exception occurred."),_this._sendLog.apply(_this,["["+module+"] CRITICAL: "+message].concat(__slice.call(context))),new exception(module,message,context)}}return CoreDevAPI}(CoreAPI),this.__apptools_preinit.abstract_base_classes.push(CoreDevAPI),ModelException=function(_super){__extends(ModelException,_super);function ModelException(source,message){this.source=source,this.message=message}return ModelException.prototype.toString=function(){return"["+this.source+"] ModelException: "+this.message},ModelException}(Error),CoreModelAPI=function(_super){__extends(CoreModelAPI,_super),CoreModelAPI.mount="model",CoreModelAPI.events=[];function CoreModelAPI(){var _this=this;this.internal={block:function(){var async_method,params,results,_done;async_method=arguments[0],params=2<=arguments.length?__slice.call(arguments,1):[],_done=!1,results=null,async_method.apply(null,__slice.call(params).concat([function(r){return results=r,_done=!0}]));for(;;)if(_done!==!1)break;return results}},this.put=function(object){return _this.internal.block(_this.put_async,object)},this.get=function(key,kind){return _this.internal.block(_this.get_async,key,kind)},this["delete"]=function(key,kind){return _this.internal.block(_this.delete_async,key,kind)},this.put_async=function(callback){return callback==null&&(callback=function(x){return x}),apptools.storage.put(_this.constructor.prototype.name,callback)},this.get_async=function(key,callback){return callback==null&&(callback=function(x){return x}),apptools.storage.get(_this.key,_this.constructor.prototype.name,callback)},this.delete_async=function(callback){return callback==null&&(callback=function(x){return x}),apptools.storage["delete"](_this.key,_this.constructor.prototype.name,callback)},this.all=function(callback){throw callback==null||(Util!=null?!Util.is_function(callback):!void 0)?callback!=null?"Provided callback isn't a function. Whoops.":"all() requires a callback.":"all() currently in active development, sorry."},this.register=function(){return apptools.dev.verbose("CoreModelAPI","register() currently in active development, sorry.")}}return CoreModelAPI.init=function(){},CoreModelAPI}(CoreAPI),Model=function(){Model.prototype.log=function(source,message){return message!=null?$.apptools!=null?$.apptools.dev.verbose(source,message):console.log("["+source+"]",message):source!=null?(message=source,source=this.constructor.name,this.log(source,message)):this.log("Model","No message passed to log(). (You get a log message anyway <3)")},Model.prototype.validate=function(object,cls,safe){var check,key,results,value,_this=this;cls==null&&(cls=object.constructor.prototype.model),safe==null&&(safe=!1);if(object!=null){safe?(results={},check=function(k,v){if(cls[k]!=null&&v!=null==(cls[k]!=null)&&v.constructor.name===cls[k].constructor.name)return results[k]=v}):(results=[],check=function(k,v){if(cls[k]==null||v!=null!=(cls[k]!=null)||v.constructor.name!==cls[k].constructor.name)return results.push({k:v})});for(key in object){if(!__hasProp.call(object,key))continue;value=object[key],check(key,value)}return safe?results:results.length===0}throw new ModelException(this.constructor.name,"No object passed to validate().")},Model.prototype.from_message=function(object,message,strict){var cached_obj,modsafe,p,prop,v,val;message==null&&(message={}),strict==null&&(strict=!1);if(object!=null){cached_obj=object,this.log("Validating incoming RPC update...");if(this.validate(message,object.constructor.prototype.model)){for(prop in message){if(!__hasProp.call(message,prop))continue;val=message[prop],object[prop]=val}return this.log("Valid model matched. Returning updated object..."),object}this.log("Strict validation failed.");if(!strict){this.log("Nonstrict validation allowed, trying modelsafe conversion..."),modsafe=this.validate(message,object.constructor.prototype.model,!0);if(Util.is_empty_object(modsafe))return this.log("No modelsafe properties found, canceling update..."),cached_obj;for(p in modsafe){if(!__hasProp.call(modsafe,p))continue;v=modsafe[p],object[p]=v}return this.log("Modelsafe conversion succeeded! Returning updated object..."),object}return this.log("Strict validation only, canceling update..."),cached_obj}throw new ModelException(this.constructor.name,"No object passed to from_message().")},Model.prototype.to_message=function(object){var message,prop,val;if(object!=null){message={};for(prop in object){if(!__hasProp.call(object,prop))continue;val=object[prop],object.constructor.prototype.model[prop]!=null&&typeof val!="function"&&(message[prop]=val)}return message}throw new ModelException(this.constructor.name,"No object passed to to_message().")};function Model(key){this.to_message=__bind(this.to_message,this),this.from_message=__bind(this.from_message,this),this.validate=__bind(this.validate,this),this.log=__bind(this.log,this);var prop,val,_this=this;if(Util.is_raw_object(key))for(prop in key)val=key[prop],this[prop]=val;else this.key=key;this.from_message=function(message,strict){return _this.constructor.prototype.from_message(_this,message,strict)},this.to_message=function(){return _this.constructor.prototype.to_message(_this)},this.log=function(message){return _this.constructor.prototype.log(_this.constructor.name,message)}}return Model}(),this.__apptools_preinit.abstract_base_classes.push(CoreModelAPI),this.__apptools_preinit.abstract_base_classes.push(Model),CoreEventsAPI=function(_super){__extends(CoreEventsAPI,_super),CoreEventsAPI.mount="events",CoreEventsAPI.events=[];function CoreEventsAPI(apptools,window){var _this=this;this.registry=[],this.callchain={},this.history=[],this.fire=this.trigger=function(){var args,bridge,callback_directive,event,event_bridges,hook_error_count,hook_exec_count,result,touched_events,_i,_j,_len,_len2,_ref;event=arguments[0],args=2<=arguments.length?__slice.call(arguments,1):[],apptools.dev.verbose("Events","Triggered event:",event,args,_this.callchain[event]);if(__indexOf.call(_this.registry,event)>=0){hook_exec_count=0,hook_error_count=0,event_bridges=[],touched_events=[],touched_events.push(event),_ref=_this.callchain[event].hooks;for(_i=0,_len=_ref.length;_i<_len;_i++){callback_directive=_ref[_i];try{if(callback_directive.once===!0&&callback_directive.has_run===!0)continue;callback_directive.bridge!=null==0?(result=callback_directive.fn.apply(callback_directive,args),hook_exec_count++,_this.history.push({event:event,callback:callback_directive,args:args,result:result}),callback_directive.has_run=!0):callback_directive.bridge===!0&&event_bridges.push({event:callback_directive.event,args:args})}catch(error){hook_error_count++,_this.history.push({event:event,callback:callback_directive,args:args,error:error})}}for(_j=0,_len2=event_bridges.length;_j<_len2;_j++)bridge=event_bridges[_j],touched_events.push(bridge.event),_this.trigger.apply(_this,[bridge.event].concat(__slice.call(bridge.args)));return{events:touched_events,executed:hook_exec_count,errors:hook_error_count}}return!1},this.create=this.register=function(names){var name,_i,_len;names instanceof Array||(names=[names]);for(_i=0,_len=names.length;_i<_len;_i++)name=names[_i],_this.registry.push.apply(_this.registry,names),_this.callchain[name]={hooks:[]};return apptools.dev.verbose("Events","Registered events:",{count:names.length,events:names}),!0},this.on=this.upon=this.when=this.hook=function(event,callback,once){return once==null&&(once=!1),__indexOf.call(_this.registry,event)<0&&(apptools.dev.warning("Events",""),_this.register(event)),_this.callchain[event].hooks.push({fn:callback,once:once,has_run:!1,bridge:!1}),apptools.dev.verbose("Events","Hook registered on event.",event),!0},this.delegate=this.bridge=function(from_events,to_events){var source_ev,target_ev,_i,_len,_results;typeof to_events=="string"&&(to_events=[to_events]),typeof from_events=="string"&&(from_events=[from_events]),_results=[];for(_i=0,_len=from_events.length;_i<_len;_i++)source_ev=from_events[_i],_results.push(function(){var _j,_len2,_results2;_results2=[];for(_j=0,_len2=to_events.length;_j<_len2;_j++
)target_ev=to_events[_j],apptools.dev.verbose("Events","Bridging events:",source_ev,"->",target_ev),this.callchain[source_ev]==null&&(apptools.dev.warn("Events","Bridging from undefined source event:",source_ev),this.register(source_ev)),_results2.push(this.callchain[source_ev].hooks.push({event:target_ev,bridge:!0}));return _results2}.call(_this));return _results}}return CoreEventsAPI}(CoreAPI),this.__apptools_preinit.abstract_base_classes.push(CoreEventsAPI),CoreAgentAPI=function(_super){__extends(CoreAgentAPI,_super),CoreAgentAPI.mount="agent",CoreAgentAPI.events=["UA_DISCOVER"];function CoreAgentAPI(apptools,window){this._data={},this.platform={},this.capabilities={},apptools.lib.modernizr!=null&&(this.capabilities=apptools.lib.modernizr),this.capabilities.simple={},this._data={browsers:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],os:[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]}}return CoreAgentAPI.prototype._makeMatch=function(data){var prop,string,value,_i,_len;for(_i=0,_len=data.length;_i<_len;_i++){value=data[_i],string=value.string,prop=value.prop,this._data.versionSearchString=value.versionSearch||value.identity;if(string!==null){if(value.string.indexOf(value.subString)!==-1)return value.identity}else if(prop)return value.identity}},CoreAgentAPI.prototype._makeVersion=function(dataString){var index;index=dataString.indexOf(this._data.versionSearchString);if(index!==-1)return parseFloat(dataString.substring(index+this._data.versionSearchString.length+1))},CoreAgentAPI.prototype.discover=function(){var browser,mobile,os,type,version;browser=this._makeMatch(this._data.browsers)||"unknown",version=this._makeVersion(navigator.userAgent)||this._makeVersion(navigator.appVersion)||"unknown",os=this._makeMatch(this._data.os)||"unknown";if(browser==="iPod/iPhone"||browser==="Android")type="mobile",mobile=!1;this.platform={os:os,type:type,vendor:navigator.vendor,product:navigator.product,browser:browser,version:version,flags:{online:navigator.onLine||!0,mobile:mobile,webkit:$.browser.webkit,msie:$.browser.msie,opera:$.browser.opera,mozilla:$.browser.mozilla}},this.capabilities.simple.cookies=navigator.cookieEnabled;if(window.jQuery!=null)return this.capabilities.simple.ajax=$.support.ajax},CoreAgentAPI}(CoreAPI),this.__apptools_preinit.abstract_base_classes.push(CoreAgentAPI),CoreDispatchAPI=function(_super){__extends(CoreDispatchAPI,_super),CoreDispatchAPI.mount="dispatch",CoreDispatchAPI.events=[];function CoreDispatchAPI(apptools,window){var _this=this;this.state={opened:!1,receiving:!1,error:!1,history:{errors:[],received:[]},pending:{},complete:{}},this.init=function(){return _this.state.opened=!0,apptools.dev.verbose("Dispatch","Dispatch startup signal received.")},this.expect=function(id,request,xhr){return _this.state.pending[id]={request:request,callbacks:callbacks,xhr:xhr},apptools.dev.verbose("Dispatch","Received EXPECT signal.",id,request,callbacks,xhr)},this.receive=function(raw_response){var context,response,_base,_base2,_base3;try{response=JSON.parse(raw_response.data)}catch(e){response=raw_response.data}return apptools.dev.verbose("Dispatch","Parsed async message.",response),_this.state.history.received.push(raw_response),response.status==="ok"?(apptools.dev.verbose("Dispatch","Triggering deferred success callback."),_this.state.complete[response.id]=_this.state.pending[response.id],_this.state.complete[response.id].response=response,delete _this.state.pending[response.id],apptools.dev.log("RPC","Success",raw_response.data,response.status,_this.state.complete[response.id].xhr),apptools.api.rpc.lastResponse=raw_response.data,apptools.api.rpc.history[response.id].xhr=_this.state.complete[response.id].xhr,apptools.api.rpc.history[response.id].status=response.status,apptools.api.rpc.history[response.id].response=raw_response.data,context={xhr:_this.state.complete[response.id].xhr,status:response.status,data:raw_response.data},apptools.events.trigger("RPC_SUCCESS",context),typeof (_base=_this.state.complete[response.id].callbacks).success=="function"?_base.success(response.response.content):void 0):response.status==="notify"?(apptools.dev.verbose("Dispatch","Received NOTIFY signal."),typeof (_base2=_this.state.pending[response.id].callbacks).notify=="function"?_base2.notify(response.response.content):void 0):(apptools.dev.error("Dispatch","Userland deferred task error. Calling error callback.",response),typeof (_base3=_this.state.pending[response.id].callbacks).error=="function"?_base3.error(response.content):void 0)},this.error=function(error){return _this.state.error=!0,_this.history.errors.push(error),apptools.dev.error("Dispatch","Dispatch error state triggered.",error)},this.close=function(){return _this.state.opened=!1,_this.state.receiving=!1,apptools.dev.verbose("Dispatch","Dispatch shutdown signal received.")}}return CoreDispatchAPI}(CoreAPI),this.__apptools_preinit.abstract_base_classes.push(CoreDispatchAPI),StorageDriver=function(_super){__extends(StorageDriver,_super),StorageDriver.methods=["compatible","construct"],StorageDriver["export"]="public";function StorageDriver(){}return StorageDriver}(CoreInterface),this.compatible=function(){},this.construct=function(){},StorageAdapter=function(_super){__extends(StorageAdapter,_super),StorageAdapter.methods=["get","put","delete","clear","get_async","put_async","delete_async","clear_async"],StorageAdapter["export"]="public";function StorageAdapter(){return}return StorageAdapter}(CoreInterface),KeyEncoder=function(_super){__extends(KeyEncoder,_super),KeyEncoder.methods=["build_key","encode_key","build_cluster","encode_cluster"],KeyEncoder["export"]="public";function KeyEncoder(){return}return KeyEncoder}(CoreInterface),this.__apptools_preinit!=null?(this.__apptools_preinit.abstract_base_classes==null&&(this.__apptools_preinit.abstract_base_classes=[]),this.__apptools_preinit.deferred_core_modules==null&&(this.__apptools_preinit.deferred_core_modules=[])):this.__apptools_preinit={abstract_base_classes:[],deferred_core_modules:[]},this.__apptools_preinit.detected_storage_engines=[],this.__apptools_preinit.abstract_base_classes.push(StorageDriver),this.__apptools_preinit.abstract_base_classes.push(StorageAdapter),this.__apptools_preinit.abstract_feature_interfaces.push({adapter:StorageDriver,name:"storage"}),SimpleKeyEncoder=function(_super){__extends(SimpleKeyEncoder,_super);function SimpleKeyEncoder(){var _this=this;this.build_key=function(){},this.encode_key=function(){},this.build_cluster=function(){},this.encode_cluster=function(){}}return SimpleKeyEncoder}(KeyEncoder),_simple_key_encoder=new SimpleKeyEncoder,LocalStorageEngine=function(_super){__extends(LocalStorageEngine,_super),LocalStorageEngine._state={runtime:{count:{total_keys:0,by_kind:[]}}};function LocalStorageEngine(name){var _this=this;this.name=name,this.get_async=function(key,callback){var object;return callback.call(object=_this.get(key))},this.put_async=function(key,value,callback){return _this.put(key,value),callback.call(value)},this.delete_async=function(key,callback){return _this["delete"](key),callback.call(_this)},this.clear_async=function(callback){return _this.clear(),callback.call(_this)},this.get=function(key){return localStorage.getItem(key)},this.put=function(key,value){return _this.get(key)==null&&_this._state.runtime.count.total_keys++,localStorage.setItem(key,value)},this["delete"]=function(key){return _this._state.runtime.count.total_keys--,localStorage.removeItem(key)},this.clear=function(){return _this._state.runtime.count.total_keys=0,localStorage.clear()};return}return LocalStorageEngine}(StorageAdapter),SessionStorageEngine=function(_super){__extends(SessionStorageEngine,_super),SessionStorageEngine._state={runtime:{count:{total_keys:0,by_kind:[]}}};function SessionStorageEngine(name){var _this=this;this.name=name,this.get_async=function(key,callback){var object;return callback.call(object=_this.get(key))},this.put_async=function(key,value,callback){return _this.put(key,value),callback.call(value)},this.delete_async=function(key,callback){return _this["delete"](key),callback.call(_this)},this.clear_async=function(callback){return _this.clear(),callback.call(_this)},this.get=function(key){return sessionStorage.getItem(key)},this.put=function(key,value){return _this.get(key)==null&&_this._state.runtime.count.total_keys++,sessionStorage.setItem(key,value)},this["delete"]=function(key){return _this._state.runtime.count.total_keys--,sessionStorage.removeItem(key)},this.clear=function(){return _this._state.runtime.count.total_keys=0,sessionStorage.clear()};return}return SessionStorageEngine}(StorageAdapter),LocalStorageDriver=function(_super){__extends(LocalStorageDriver,_super);function LocalStorageDriver(){LocalStorageDriver.__super__.constructor.apply(this,arguments)}return LocalStorageDriver._state={constructor:function(){var _this=this;this.compatible=function(){return!!window.localStorage},this.construct=function(name){var new_engine;return name==null&&(name="appstorage"),_this.compatible()?new_engine=new LocalStorageEngine(name):!1}}},LocalStorageDriver}(StorageDriver),SessionStorageDriver=function(_super){__extends(SessionStorageDriver,_super);function SessionStorageDriver(){SessionStorageDriver.__super__.constructor.apply(this,arguments)}return SessionStorageDriver._state={constructor:function(){var _this=this;this.compatible=function(){return!!window.sessionStorage},this.construct=function(name){var new_engine;return name==null&&(name="appstorage"),_this.compatible()?new_engine=new SessionStorageEngine(name):!1}}},SessionStorageDriver}(StorageDriver),this.__apptools_preinit.detected_storage_engines.push({name:"LocalStorage",adapter:LocalStorageEngine,driver:LocalStorageDriver,key_encoder:_simple_key_encoder}),this.__apptools_preinit.detected_storage_engines.push({name:"SessionStorage",adapter:SessionStorageEngine,driver:SessionStorageDriver,key_encoder:_simple_key_encoder}),IndexedDBEngine=function(_super){__extends(IndexedDBEngine,_super);function IndexedDBEngine(){return}return IndexedDBEngine}(StorageAdapter),IndexedDBDriver=function(_super){__extends(IndexedDBDriver,_super);function IndexedDBDriver(){return}return IndexedDBDriver}(StorageDriver),this.__apptools_preinit.detected_storage_engines.push({name:"IndexedDB",adapter:IndexedDBEngine,driver:IndexedDBDriver}),WebSQLEngine=function(_super){__extends(WebSQLEngine,_super);function WebSQLEngine(){return}return WebSQLEngine}(StorageAdapter),WebSQLDriver=function(_super){__extends(WebSQLDriver,_super);function WebSQLDriver(){return}return WebSQLDriver}(StorageDriver),this.__apptools_preinit.detected_storage_engines.push({name:"WebSQL",adapter:WebSQLEngine,driver:WebSQLDriver}),CoreStorageAPI=function(_super){__extends(CoreStorageAPI,_super),CoreStorageAPI.mount="storage",CoreStorageAPI.events=["STORAGE_INIT","ENGINE_LOADED","STORAGE_READY","STORAGE_ERROR","STORAGE_ACTIVITY","STORAGE_READ","STORAGE_WRITE","STORAGE_DELETE","COLLECTION_SCAN","COLLECTION_CREATE","COLLECTION_DESTROY","COLLECTION_UPDATE","COLLECTION_SYNC"];function CoreStorageAPI(apptools,window){var _this=this;this._state={runtime:{index:{key_read_tally:{},key_write_tally:{},local_by_key:{},local_by_kind:{}},count:{total_keys:0,by_collection:[],by_kind:[]},data:{}},config:{autoload:!1,autosync:{enabled:!1,interval:120},drivers:[],engines:{},encrypt:!1,integrity:!1,obfuscate:!1,local_only:!1,callbacks:{ready:null,sync:null}},supervisor:{},cachebridge:{},model_kind_map:{},collection_kind_map:{}},this.internal={check_support:function(modernizr){},bootstrap:function(lawnchair){},provision_collection:function(name,adapter,callback){},add_storage_engine:function(name,driver,engine){var d,e;try{d=new driver(apptools),e=new engine(apptools)}catch(err){return!1}return e.compatible()?(_this._state.config.engines[name]=e,driver.adapter=_this._state.config.engines[name],_this._state.config.drivers.push(driver),apptools.sys.drivers.install("storage",name,d,d.enabled!=null|!0,d.priority!=null|50,function(driver){return apptools.events.trigger("ENGINE_LOADED",{driver:driver,engine:driver.adapter})}),!0):(apptools.dev.verbose("StorageEngine","Detected incompatible storage engine. Skipping.",name,driver,engine),!1)}},this.get=function(){},this.list=function(){},this.count=function(){},this.put=function(){},this.query=function(){},this["delete"]=function(){},this.sync=function(){},this._init=function(){var engine,_i,_len,_ref,_ref2,_ref3;apptools.events.trigger("STORAGE_INIT"),apptools.dev.verbose("Storage","Storage support is currently under construction.");if(((_ref=apptools.sys)!=null?(_ref2=_ref.preinit)!=null?_ref2.detected_storage_engines:void 0:void 0)!=null){_ref3=apptools.sys.preinit.detected_storage_engines;for(_i=0,_len=_ref3.length;_i<_len;_i++)engine=_ref3[_i],_this.internal.add_storage_engine(engine.name,engine.driver,engine.adapter)}return apptools.events.trigger("STORAGE_READY")},apptools.events.bridge(["STORAGE_READ","STORAGE_WRITE","STORAGE_DELETE"],"STORAGE_ACTIVITY"),apptools.events.bridge(["COLLECTION_CREATE","COLLECTION_UPDATE","COLLECTION_DESTROY","COLLECTION_SYNC","COLLECTION_SCAN"],"STORAGE_ACTIVITY")}return CoreStorageAPI}(CoreAPI),this.__apptools_preinit.abstract_base_classes.push(CoreStorageAPI),RPCAPI=function(_super){__extends(RPCAPI,_super);function RPCAPI(name,base_uri,methods,config){var method,_i,_len,_ref;this.name=name,this.base_uri=base_uri,this.methods=methods,this.config=config;if(this.methods.length>0){_ref=this.methods;for(_i=0,_len=_ref.length;_i<_len;_i++)method=_ref[_i],this[method]=this._buildRPCMethod(method,base_uri,config)}}return RPCAPI.prototype._buildRPCMethod=function(method,base_uri,config){var api,rpcMethod,_this=this;return api=this.name,rpcMethod=function(params,callbacks,async,push,opts,config){return params==null&&(params={}),callbacks==null&&(callbacks=null),async==null&&(async=!1),push==null&&(push=!1),opts==null&&(opts={}),config==null&&(config={}),function(params,callbacks,async,push,opts){var request;return request=$.apptools.api.rpc.createRPCRequest({method:method,api:api,params:params||{},opts:opts||{},async:async||!1,push:push||!1}),callbacks!==null?request.fulfill(callbacks,config):request}(params,callbacks,async,push,opts)},$.apptools.api.registerAPIMethod(api,method,base_uri,config),rpcMethod},RPCAPI}(CoreObject),RPCRequest=function(_super){__extends(RPCRequest,_super);function RPCRequest(id,opts,agent){this.params={},this.action=null,this.method=null,this.api=null,this.base_uri=null,this.envelope={id:null,opts:{},agent:{}},this.ajax={accept:"application/json",async:!0,cache:!0,global:!0,http_method:"POST",crossDomain:!1,processData:!1,ifModified:!1,dataType:"json",push:!1,contentType:"application/json; charset=utf-8"},id!=null&&(this.envelope.id=id),opts!=null&&(this.envelope.opts=opts),agent!=null&&(this.envelope.agent=agent)}return RPCRequest.prototype.fulfill=function(callbacks,config){var defaultFailureCallback,defaultSuccessCallback,_this=this;return callbacks==null&&(callbacks={}),(callbacks!=null?callbacks.success:void 0)==null&&(defaultSuccessCallback=function(context,type,data){return $.apptools.dev.log("RPC","RPC succeeded but had no success callback.",_this,context,type,data)},callbacks.success=defaultSuccessCallback),(callbacks!=null?callbacks.failure:void 0)==null&&(defaultFailureCallback=function(context){return $.apptools.dev.error("RPC","RPC failed but had no failure callback.",_this,context)},callbacks.failure=defaultFailureCallback),$.apptools.api.rpc.fulfillRPCRequest(config,this,callbacks)},RPCRequest.prototype.setAsync=function(async){var _ref;return(_ref=this.ajax)!=null&&_ref.async==null&&(_ref.async=async),this},RPCRequest.prototype.setPush=function(push){return push===!0&&(this.ajax.push=!0,this.envelope.opts.alt="socket",this.envelope.opts.token=$.apptools.push.state.config.token),this},RPCRequest.prototype.setOpts=function(opts){var _ref,_ref2;return(_ref=this.envelope)!=null&&(_ref.opts=_.defaults(opts,(_ref2=this.envelope)!=null?_ref2.opts:void 0)),this},RPCRequest.prototype.setAgent=function(agent){var _ref;return(_ref=this.envelope)!=null&&_ref.agent==null&&(_ref.agent=agent),this},RPCRequest.prototype.setAction=function(action){return this.action=action,this},RPCRequest.prototype.setMethod=function(method){return this.method=method,this},RPCRequest.prototype.setAPI=function(api){return this.api=api,this},RPCRequest.prototype.setBaseURI=function(base_uri){return this.base_uri=base_uri,this},RPCRequest.prototype.setParams=function(params){return this.params=params!=null?params:{},this},RPCRequest.prototype.payload=function(){var _payload;return _payload={id:this.envelope.id,opts:this.envelope.opts,agent:this.envelope.agent,request:{params:this.params,method:this.method,api:this.api}},_payload},RPCRequest}(CoreObject),RPCResponse=function(_super){__extends(RPCResponse,_super);function RPCResponse(){var args;args=1<=arguments.length?__slice.call(arguments,0):[],$.apptools.dev.verbose("RPC","RPCResponse is not yet implemented and is currently stubbed.");return}return RPCResponse}(CoreObject),CoreRPCAPI=function(_super){__extends(CoreRPCAPI,_super),CoreRPCAPI.mount="api",CoreRPCAPI.events=["RPC_CREATE","RPC_FULFILL","RPC_SUCCESS","RPC_ERROR","RPC_COMPLETE","RPC_PROGRESS"];function CoreRPCAPI(apptools,window){var original_xhr,_ref,_ref2,_this=this;this.state={sockets:{token:"__NULL__",enabled:!1,status:"DISCONNECTED","default":null,default_host:((_ref=apptools.config)!=null?(_ref2=_ref.rpc)!=null?_ref2.socket_host:void 0:void 0)!=null||null}},this.base_rpc_uri=apptools.config.rpc.base_uri||"/_api/rpc",this.socket_host=apptools.config.rpc.socket_host||null,apptools.sys.libraries.resolve("jQuery")!==!1?original_xhr=$.ajaxSettings.xhr:original_xhr=new XMLHTTPRequest,this.internals={transports:{xhr:{factory:function(){var req;return req=original_xhr(),req&&typeof req.addEventListener=="function"&&req.addEventListener("progress",function(ev){return apptools.events.trigger("RPC_PROGRESS",{event:ev})},!1),req}},websocket:{factory:function(){var req,socket,_ref3,_ref4,_ref5,_ref6;if(apptools.agent.capabilities.websockets==null)throw apptools.dev.error("RPC","Socket factory can't produce a socket because the client platform does not support WebSockets."),"SocketsNotSupported: The client platform does not have support for websockets.";if(((_ref3=_this.state.sockets)!=null?_ref3.enabled:void 0)!=null==1)return((_ref4=_this.state.sockets)!=null?_ref4["default"]:void 0)!=null===null&&((_ref5=_this.state.sockets)!=null?(_ref6=_ref5.open)!=null?_ref6.length:void 0:void 0)===0&&(socket=new apptools.push.socket.establish,_this.state.sockets.enabled=!0,_this.state.sockets["default"]=socket,_this.state.sockets.status="CONNECTED"),req={},req}}},config:{headers:{"X-ServiceClient":["AppToolsJS/",[AppTools.version.major.toString(),AppTools.version.minor.toString(),AppTools.version.micro.toString(),AppTools.version.build.toString()].join("."),"-",AppTools.version.release.toString()].join(""),"X-ServiceTransport":"AppTools/JSONRPC"}}},this.rpc={lastRequest:null,lastFailure:null,lastResponse:null,history:{},action_prefix:null,alt_push_response:!1,used_ids:[],factory:function(name_or_apis,base_uri,methods,config){var item,name,_i,_len;if(Util.is_array(name_or_apis)){if(name_or_apis!=null)for(_i=0,_len=name_or_apis.length;_i<_len;_i++)item=name_or_apis[_i],apptools.api[name=item.name]=new RPCAPI(name,item.base_uri,item.methods,item.config)}else apptools.api[name=name_or_apis]=new RPCAPI(name,base_uri,methods,config);return _this},_assembleRPCURL:function(method,api,prefix,base_uri){if(api==null&&base_uri==null)throw"[RPC] Error: Must specify either an API or base URI to generate an RPC endpoint.";return api!=null?base_uri!=null?base_uri=base_uri+"/"+api:base_uri=_this.base_rpc_uri+"/"+api:base_uri==null&&(base_uri=_this.base_rpc_uri),prefix!==null?[prefix+base_uri,method].join("."):[base_uri,method].join(".")},provisionRequestID:function(){var id;return _this.rpc.used_ids.length>0?(id=Math.max.apply(_this,_this.rpc.used_ids)+1,_this.rpc.used_ids.push(id),id):(_this.rpc.used_ids.push(1),1)},decodeRPCResponse:function(data,status,xhr,success,error){return success(data,status)},createRPCRequest:function(config){var request;return request=new RPCRequest(_this.rpc.provisionRequestID()),config.api!=null&&request.setAPI(config.api),config.method!=null&&request.setMethod(config.method),config.agent!=null&&request.setAgent(config.agent),config.opts!=null&&request.setOpts(config.opts),config.base_uri!=null&&request.setBaseURI(config.base_uri),config.params!=null&&request.setParams(config.params),config.async!=null&&request.setAsync(config.async),config.push!=null?request.setPush(config.push):request.setPush(_this.rpc.alt_push_response),apptools.dev.verbose("RPC","New Request",request,config),request.setAction(_this.rpc._assembleRPCURL(request.method,request.api,_this.rpc.action_prefix,_this.base_rpc_uri)),request},fulfillRPCRequest:function(config,request,callbacks,transport){var context;transport==null&&(transport="xhr"),apptools.dev.verbose("RPC","Fulfill",config,request,callbacks),apptools.sys.libraries.resolve("jQuery")!==!1&&$.ajaxSetup({type:"POST",accepts:"application/json",contentType:"application/json",global:!0,xhr:function(){return _this.internals.transports.xhr.factory()},headers:_this.internals.config.headers}),_this.rpc.lastRequest=request,_this.rpc.history[request.envelope.id]={request:request,config:config,callbacks:callbacks};if(request.action===null){if(request.method===null)throw"[RPC] Error: Request must specify at least an action or method.";if(request.base_uri===null){if(request.api===null)throw"[RPC] Error: Request must have an API or explicity defined BASE_URI.";request.action=_this.rpc._assembleRPCURL(request.method,request.api,_this.rpc.action_prefix)}else request.action=_this.rpc._assembleRPCURL(request.method,null,_this.rpc.action_prefix,request.base_uri)}if(request.action===null||request.action===void 0)throw"[RPC] Error: Could not determine RPC action.";return context={config:config,request:request,callbacks:callbacks},apptools.events.trigger("RPC_FULFILL",context),function(apptools,request,callbacks){var driver,xhr,xhr_action,xhr_settings,_this=this;xhr_settings={resourceId:request.api+"."+request.method,url:request.action,data:JSON.stringify(request.payload()),async:request.ajax.async,global:request.ajax.global,type:request.ajax.http_method||"POST",accepts:request.ajax.accepts||"application/json",crossDomain:request.ajax.crossDomain,dataType:request.ajax.dataType,processData:!1,ifModified:request.ajax.ifModified,contentType:request.ajax.contentType,beforeSend:function(xhr,settings){return apptools.api.rpc.history[request.envelope.id].xhr=xhr,callbacks!=null&&typeof callbacks.status=="function"&&callbacks.status("beforeSend"),xhr},error:function(xhr,status,error){return callbacks!=null&&typeof callbacks.status=="function"&&callbacks.status("error"),apptools.dev.error("RPC","Error: ",{error:error,status:status,xhr:xhr}),apptools.api.rpc.lastFailure=error,apptools.api.rpc.history[request.envelope.id].xhr=xhr,apptools.api.rpc.history[request.envelope.id].status=status,apptools.api.rpc.history[request.envelope.id].failure=error,context={xhr:xhr,status:status,error:error},apptools.events.trigger("RPC_ERROR",context),apptools.events.trigger("RPC_COMPLETE",context),callbacks!=null?typeof callbacks.failure=="function"?callbacks.failure(error):void 0:void 0},success:function(data,status,xhr){return data.status==="ok"?(callbacks!=null&&typeof callbacks.status=="function"&&callbacks.status("success"),apptools.dev.log("RPC","Success",data,status,xhr),apptools.api.rpc.lastResponse=data,apptools.api.rpc.history[request.envelope.id].xhr=xhr,apptools.api.rpc.history[request.envelope.id].status=status,apptools.api.rpc.history[request.envelope.id].response=data,context={xhr:xhr,status:status,data:data},apptools.events.trigger("RPC_SUCCESS",context),apptools.events.trigger("RPC_COMPLETE",context),callbacks!=null?typeof callbacks.success=="function"?callbacks.success(data.response.content,data.response.type,data):void 0:void 0):data.status==="wait"?(callbacks!=null&&typeof callbacks.status=="function"&&callbacks.status("wait"),apptools.dev.log("RPC","PushWait",data,status,xhr),context={xhr:xhr,status:status,data:data},callbacks!=null&&typeof callbacks.wait=="function"&&callbacks.wait(data,status,xhr),apptools.push.internal.expect(request.envelope.id,request,xhr)):data.status==="fail"?(callbacks!=null&&typeof callbacks.status=="function"&&callbacks.status("error"),apptools.dev.error("RPC","Error: ",{error:data,status:status,xhr:xhr}),apptools.api.rpc.lastFailure=data,apptools.api.rpc.history[request.envelope.id].xhr=xhr,apptools.api.rpc.history[request.envelope.id].status=status,apptools.api.rpc.history[request.envelope.id].failure=data,context={xhr:xhr,status:status,error:data},apptools.events.trigger("RPC_ERROR",context),apptools.events.trigger("RPC_COMPLETE",context),callbacks!=null?typeof callbacks.failure=="function"?callbacks.failure(data):void 0:void 0):callbacks!=null?typeof callbacks.success=="function"?callbacks.success(data.response.content,data.response.type,data):void 0:void 0},statusCode:{404:function(){return apptools.dev.error("RPC","HTTP/404","Could not resolve RPC action URI."),apptools.events.trigger("RPC_ERROR",{message:"RPC 404: Could not resolve RPC action URI.",code:404})},403:function(){return apptools.dev.error("RPC","HTTP/403","Not authorized to access the specified endpoint."),apptools.events.trigger("RPC_ERROR",{message:"RPC 403: Not authorized to access the specified endpoint.",code:403})},500:function(){return apptools.dev.error("RPC","HTTP/500","Internal server error."),apptools.events.trigger("RPC_ERROR",{message:"RPC 500: Woops! Something went wrong. Please try again.",code:500})}}},driver=apptools.sys.drivers.resolve("transport");if(driver.name==="amplify")apptools.dev.verbose("RPC","Fulfilling with AmplifyJS transport adapter."),xhr_action=driver.driver.request,xhr=xhr_action(xhr_settings);else{if(driver.name!=="jquery")throw apptools.dev.error("RPC","Native RPC adapter is currently stubbed."),"[RPC]: No valid AJAX transport adapter found.";apptools.dev.verbose("RPC","Fulfilling with jQuery AJAX transport adapter.",xhr_settings),xhr=jQuery.ajax(xhr_settings.url,xhr_settings)}return apptools.dev.verbose("RPC","Resulting XHR: ",xhr)}(apptools,request,callbacks),{id:request.envelope.id,request:request}}},this.ext=null,this.registerAPIMethod=function(api,name,base_uri,config){var amplify,base_settings,resourceId,_ref3;if(apptools!=null?(_ref3=apptools.sys)!=null?_ref3.drivers:void 0:void 0){amplify=apptools.sys.drivers.resolve("transport","amplify");if(amplify!==!1)return apptools.dev.log("RPCAPI",'Registering request procedure "'+api+"."+name+'" with AmplifyJS.'),resourceId=api+"."+name,base_settings={accepts:"application/json",type:"POST",dataType:"json",contentType:"application/json",url:_this.rpc._assembleRPCURL(name,api,null,base_uri),decoder:_this.rpc.decodeRPCResponse},config.caching!=null?(config.caching===!0&&(base_settings.caching="persist"),amplify.request.define(resourceId,"ajax",base_settings)):amplify.request.define(resourceId,"ajax",base_settings)}}}return CoreRPCAPI}(CoreAPI),RPCDriver=function(_super){__extends(RPCDriver,_super),RPCDriver.methods=[],RPCDriver["export"]="private";function RPCDriver(){return}return RPCDriver}(CoreInterface),this.__apptools_preinit.abstract_base_classes.push(RPCAPI),this.__apptools_preinit.abstract_base_classes.push(RPCDriver),this.__apptools_preinit.abstract_base_classes.push(CoreRPCAPI),this.__apptools_preinit.abstract_base_classes.push(RPCRequest),this.__apptools_preinit.abstract_base_classes.push(RPCResponse),this.__apptools_preinit.abstract_feature_interfaces.push({adapter:RPCDriver,name:"transport"}),CoreUserAPI=function(_super){__extends(CoreUserAPI,_super),CoreUserAPI.mount="user",CoreUserAPI.events=["SET_USER_INFO"];function CoreUserAPI(apptools,window){this.current_user=null}return CoreUserAPI.prototype.setUserInfo=function(userinfo){return this.current_user=userinfo.current_user||null,$.apptools.dev.log("UserAPI","Set server-injected userinfo: ",this.current_user),$.apptools.events.trigger("SET_USER_INFO",this.current_user)},CoreUserAPI}(CoreAPI),this.__apptools_preinit.abstract_base_classes.push(CoreUserAPI),CorePushAPI=function(_super){__extends(CorePushAPI,_super),CorePushAPI.mount="push",CorePushAPI.events=["PUSH_INIT","PUSH_READY","PUSH_STATE_CHANGE","PUSH_SOCKET_OPEN","PUSH_SOCKET_ESTABLISH","PUSH_SOCKET_ACTIVITY","PUSH_SOCKET_ACTIVITY_FINISH","PUSH_SOCKET_ERROR","PUSH_SOCKET_CLOSE"];function CorePushAPI(apptools,window){var _this=this;this.state={ready:!1,status:"init",transport:{sockets:[],channel:null},callbacks:{open:null,expect:null,activity:null,error:null,close:null},config:{token:null}},apptools.events.bridge(["PUSH_READY","PUSH_SOCKET_ESTABLISH","PUSH_SOCKET_ERROR","PUSH_SOCKET_OPEN","PUSH_SOCKET_CLOSE"],"PUSH_STATE_CHANGE"),apptools.events.hook("PUSH_SOCKET_OPEN",function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],apptools.api.rpc.alt_push_response=!0}),apptools.events.hook("PUSH_SOCKET_CLOSE",function(){var args;return args=1<=arguments.length?__slice.call(arguments,0):[],apptools.api.rpc.alt_push_response=!1}),this.events={on_open:function(socket){if(_this.state.transport.sockets.length=0)_this.state.status="ready";return apptools.events.trigger("PUSH_SOCKET_OPEN",_this.state),apptools.dev.verbose("PushSocket","Message transport opened.")},on_message:function(socket,payload){var _base;return _this.state.status="receiving",apptools.dev.verbose("PushSocket","Message received.",payload),apptools.events.trigger("PUSH_SOCKET_ACTIVITY",_this.state),typeof (_base=_this.state.callbacks).activity=="function"&&_base.activity(payload),apptools.events.trigger("PUSH_SOCKET_ACTIVITY_FINISH",_this.state)},on_error:function(socket,error){return _this.state.status="error",apptools.dev.error("PushSocket","Message transport error.",error),apptools.events.trigger("PUSH_SOCKET_ERROR",_this.state)},on_close:function(socket){return _this.state.ready=!1,_this.state.status="close",apptools.dev.verbose("PushSocket","Message transport closed."),apptools.events.trigger("PUSH_SOCKET_CLOSE",_this.state)}},this.internal={open_channel:function(token){return apptools.events.trigger("PUSH_INIT",{token:token,type:"channel"}),_this.state.config.token=token,_this.state.transport.channel=new goog.appengine.Channel(_this.state.config.token),_this.internal._add_socket(_this.state.transport.channel)},open_websocket:function(token,server){return apptools.events.trigger("PUSH_INIT",{token:token,server:server,type:"websocket"}),apptools.dev.log("Push","WARNING: WebSockets support is currently experimental."),_this.internal._add_socket(_this.state.transport.socket)},_add_socket:function(transport,callbacks){var socket;return socket=transport.open(),_this.state.transport.sockets.push(socket),apptools.events.trigger("PUSH_SOCKET_ESTABLISH",socket),socket.onopen=function(){var args,_ref;return args=1<=arguments.length?__slice.call(arguments,0):[],(_ref=_this.events).on_open.apply(_ref,[socket].concat(__slice.call(args)))},socket.onmessage=function(){var args,_ref;return args=1<=arguments.length?__slice.call(arguments,0):[],(_ref=_this.events).on_message.apply(_ref,[socket].concat(__slice.call(args)))},socket.onerror=function(){var args,_ref;return args=1<=arguments.length?__slice.call(arguments,0):[],(_ref=_this.events).on_error.apply(_ref,[socket].concat(__slice.call(args)))},socket.onclose=function(){var args,_ref;return args=1<=arguments.length?__slice.call(arguments,0):[],(_ref=_this.events).on_close.
apply(_ref,[socket].concat(__slice.call(args)))},_this.internal},expect:function(id,request,xhr){var _ref,_ref2;return(_ref=_this.state)!=null&&(_ref2=_ref.callbacks)!=null&&typeof _ref2.expect=="function"&&_ref2.expect(id,request,xhr),_this.internal}},this.channel={establish:function(token){return _this.internal.open_channel(token)}},this.socket={establish:function(token,host){return host==null&&(host=null),_this.internal.open_websocket(token,host||apptools.config.sockets.host)}},this.listen=function(callbacks){return _this.state.callbacks=_.defaults(callbacks,_this.state.callbacks),_this.state.ready=!0,_this.internal}}return CorePushAPI}(CoreAPI),PushDriver=function(_super){__extends(PushDriver,_super),PushDriver.methods=[],PushDriver["export"]="private";function PushDriver(){return}return PushDriver}(CoreInterface),this.__apptools_preinit.abstract_base_classes.push(PushDriver),this.__apptools_preinit.abstract_base_classes.push(CorePushAPI),this.__apptools_preinit.abstract_feature_interfaces.push({adapter:PushDriver,name:"transport"}),CoreRenderAPI=function(_super){__extends(CoreRenderAPI,_super),CoreRenderAPI.mount="render",CoreRenderAPI.events=["ADD_TEMPLATE","RENDER_TEMPLATE"],CoreRenderAPI["export"]="private";function CoreRenderAPI(apptools,window){return}return CoreRenderAPI.prototype._init=function(){},CoreRenderAPI}(CoreAPI),RenderDriver=function(_super){__extends(RenderDriver,_super),RenderDriver["export"]="private",RenderDriver.methods=["render","register_template"];function RenderDriver(){return}return RenderDriver}(CoreInterface),QueryDriver=function(_super){__extends(QueryDriver,_super),QueryDriver["export"]="private",QueryDriver.methods=["element_by_id","elements_by_class"];function QueryDriver(){return}return QueryDriver}(CoreInterface),Template=function(_super){__extends(Template,_super);function Template(){this.name="",this.source="",this.cacheable={rendered:!1,source:!1}}return Template}(Model),this.__apptools_preinit.abstract_base_classes.push(QueryDriver),this.__apptools_preinit.abstract_base_classes.push(RenderDriver),this.__apptools_preinit.abstract_base_classes.push(CoreRenderAPI),this.__apptools_preinit.abstract_feature_interfaces.push({adapter:RenderDriver,name:"render"}),AppTools=function(){AppTools.version={major:0,minor:1,micro:4,build:4282012,release:"BETA",get:function(){return[[[this.major.toString(),this.minor.toString(),this.micro.toString()].join("."),this.build.toString()].join("-"),this.release].join(" ")}};function AppTools(window){var module,_i,_len,_ref,_ref2,_this=this;this.config={rpc:{base_uri:"/_api/rpc",host:null,enabled:!0},sockets:{host:null,enabled:!1}},this.lib={},this.sys={platform:{},version:this.version,core_events:["SYS_MODULE_LOADED","SYS_LIB_LOADED","SYS_DRIVER_LOADED"],state:{status:"NOT_READY",flags:["base"],preinit:{},modules:{},classes:{},interfaces:{},integrations:[],add_flag:function(flagname){return _this.sys.state.flags.push(flagname)},consider_preinit:function(preinit){var cls,lib,_i,_interface,_j,_k,_len,_len2,_len3,_ref,_ref2,_ref3;if(preinit.abstract_base_classes!=null){_ref=preinit.abstract_base_classes;for(_i=0,_len=_ref.length;_i<_len;_i++){cls=_ref[_i],_this.sys.state.classes[cls.name]=cls,cls.package!=null&&_this.sys.state.modules[cls.package]!=null&&(_this.sys.state.modules[cls.package].classes[cls.name]=cls);if(cls["export"]!=null&&cls["export"]==="private")continue;window[cls.name]=cls}}if(preinit.deferred_library_integrations!=null){_ref2=preinit.deferred_library_integrations;for(_j=0,_len2=_ref2.length;_j<_len2;_j++)lib=_ref2[_j],_this.sys.libraries.install(lib.name,lib.library)}if(preinit.abstract_feature_interfaces!=null){_ref3=preinit.abstract_feature_interfaces;for(_k=0,_len3=_ref3.length;_k<_len3;_k++)_interface=_ref3[_k],_this.sys.interfaces.install(_interface.name,_interface.adapter)}return preinit}},modules:{install:function(module,mountpoint_or_callback,callback){var module_name,mountpoint,pass_parent,target_mod,_base;return mountpoint_or_callback==null&&(mountpoint_or_callback=null),callback==null&&(callback=null),mountpoint_or_callback!=null&&(typeof mountpoint_or_callback=="function"?(callback=mountpoint_or_callback,mountpoint=null):mountpoint=mountpoint_or_callback),mountpoint!=null?(_this[mountpoint]==null&&(_this[mountpoint]={}),mountpoint=_this[mountpoint],pass_parent=!0):(mountpoint=_this,pass_parent=!1),module.mount!=null?module_name=module.mount:module_name=module.name.toLowerCase(),module.events!=null&&_this.events!=null&&_this.events.register(module.events),mountpoint[module_name]==null&&(pass_parent?(target_mod=new module(_this,mountpoint,window),mountpoint[module_name]=target_mod,_this.sys.state.modules[module_name]={module:target_mod,classes:{}}):(target_mod=new module(_this,window),mountpoint[module_name]=target_mod,_this.sys.state.modules[module_name]={module:target_mod,classes:{}})),typeof (_base=mountpoint[module_name])._init=="function"&&_base._init(_this),_this.dev!=null&&_this.dev.verbose!=null&&_this.dev.verbose("ModuleLoader","Installed module:",target_mod," at mountpoint: ",mountpoint," under the name: ",module_name),_this.events!=null&&_this.events.trigger("SYS_MODULE_LOADED",{module:target_mod,mountpoint:mountpoint}),callback!=null&&callback(target_mod),target_mod}},libraries:{install:function(name,library,callback){return callback==null&&(callback=null),_this.lib[name.toLowerCase()]=library,_this.sys.state.integrations.push(name.toLowerCase()),_this.dev.verbose("LibLoader",name+" detected."),_this.events.trigger("SYS_LIB_LOADED",{name:name,library:library}),callback!=null&&callback(library,name),_this.lib[name.toLowerCase()]},resolve:function(name){var lib,_i,_len,_ref;name=name.toLowerCase(),_ref=_this.sys.state.integrations;for(_i=0,_len=_ref.length;_i<_len;_i++){lib=_ref[_i];if(lib!==name)continue;return _this.lib[name.toLowerCase()]}}},interfaces:{install:function(name,adapter){return _this.dev.verbose("InterfaceLoader",'Installed "'+name+'" interface.'),_this.events.trigger("SYS_INTERFACE_LOADED",{name:name,adapter:adapter}),_this.sys.state.interfaces[name]={adapter:adapter,methods:adapter.methods},_this.sys.state.interfaces[name]},resolve:function(name){return _this.sys.state.interfaces[name]!=null?_this.sys.state.interfaces[name]:!1}},drivers:{query:{},loader:{},transport:{},storage:{},render:{},install:function(type,name,adapter,mountpoint,enabled,priority,callback){return callback==null&&(callback=null),_this.sys.drivers[type][name]={name:name,driver:mountpoint,enabled:enabled,priority:priority,"interface":adapter},callback!=null&&callback(_this.sys.drivers[type][name].driver),_this.events.trigger("SYS_DRIVER_LOADED",_this.sys.drivers[type][name]),_this.sys.drivers[type][name]},resolve:function(type,name,strict){var driver,priority_state,selected_driver;name==null&&(name=null),strict==null&&(strict=!1);if(_this.sys.drivers[type]==null){apptools.dev.critical("CORE",'Unkown driver type "'+type+'".');return}if(name!=null)return _this.sys.drivers[type][name]!=null?_this.sys.drivers[type][name].driver:(strict&&apptools.dev.critical("CORE","Could not resolve driver ",name," of type ",type,"."),!1);priority_state=-1,selected_driver=!1;for(driver in _this.sys.drivers[type]){driver=_this.sys.drivers[type][driver];if(driver.priority>priority_state){selected_driver=driver;break}}return selected_driver}},go:function(){return _this.dev.log("Core","All systems go."),_this.sys.state.status="READY",_this}},this.sys.modules.install(CoreDevAPI,function(dev){return dev.verbose("CORE","CoreDevAPI is up and running.")}),this.sys.modules.install(CoreEventsAPI,function(events){return events.register(_this.sys.core_events)}),window.__apptools_preinit!=null&&(this.sys.state.preinit=window.__apptools_preinit,this.sys.state.consider_preinit(window.__apptools_preinit)),(window!=null?window.Modernizr:void 0)!=null&&this.sys.libraries.install("Modernizr",window.Modernizr,function(lib,name){return _this.load=function(){var fragments,_ref;return fragments=1<=arguments.length?__slice.call(arguments,0):[],(_ref=_this.lib.modernizr).load.apply(_ref,fragments)}}),(window!=null?window.jQuery:void 0)!=null&&this.sys.libraries.install("jQuery",window.jQuery,function(lib,name){return _this.sys.drivers.install("query","jquery",_this.sys.state.classes.QueryDriver,_this.lib.jquery,!0,100,null),_this.sys.drivers.install("transport","jquery",_this.sys.state.classes.RPCDriver,_this.lib.jquery,!0,100,null)}),(window!=null?window.Zepto:void 0)!=null&&this.sys.libraries.install("Zepto",window.Zepto,function(lib,name){return _this.sys.drivers.install("query","zepto",_this.sys.state.classes.QueryDriver,_this.lib.zepto,!0,500,null),_this.sys.drivers.install("transport","zepto",_this.sys.state.classes.RPCDriver,_this.lib.zepto,!0,500,null)}),(window!=null?window._:void 0)!=null&&this.sys.libraries.install("Underscore",window._,function(lib,name){return _this.sys.drivers.install("query","underscore",_this.sys.state.classes.QueryDriver,_this.lib.underscore,!0,50,null),_this.sys.drivers.install("render","underscore",_this.sys.state.classes.RenderDriver,_this.lib.underscore,!0,50,null)}),(window!=null?window.Backbone:void 0)!=null&&this.sys.libraries.install("Backbone",window.Backbone),(window!=null?window.Lawnchair:void 0)!=null&&this.sys.libraries.install("Lawnchair",window.Lawnchair,function(library){return _this.sys.drivers.install("storage","lawnchair",_this.sys.state.classes.StorageDriver,_this.lib.lawnchair,!0,500,function(lawnchair){return _this.dev.verbose("Lawnchair","Storage is currently stubbed. Come back later.")})}),(window!=null?window.amplify:void 0)!=null&&this.sys.libraries.install("Amplify",window.amplify,function(library){return _this.sys.drivers.register("transport","amplify",_this.sys.state.classes.RPCDriver,_this.lib.amplify,!0,500,null),_this.sys.drivers.register("storage","amplify",_this.sys.state.classes.StorageDriver,_this.lib.amplify,!0,100,null)}),(window!=null?window.Milk:void 0)!=null&&this.sys.libraries.install("Milk",window.Milk,function(library){return _this.sys.drivers.install("render","milk",_this.sys.state.classes.RenderDriver,_this.lib.milk,!0,100,function(milk){return _this.dev.verbose("Milk","Render support is currently stubbed. Come back later.")})}),(window!=null?window.Mustache:void 0)!=null&&this.sys.libraries.install("Mustache",window.Mustache,function(library){return _this.sys.drivers.register("render","mustache",_this.sys.state.classes.RenderDriver,_this.lib.mustache,!0,500,function(mustache){return _this.dev.verbose("Mustache","Render support is currently stubbed. Come back later.")})}),this.sys.modules.install(CoreModelAPI),this.sys.modules.install(CoreAgentAPI),this.sys.modules.install(CoreDispatchAPI),this.sys.modules.install(CoreRPCAPI),this.sys.modules.install(CorePushAPI),this.sys.modules.install(CoreUserAPI),this.sys.modules.install(CoreStorageAPI),this.sys.modules.install(CoreRenderAPI);if(((_ref=window.__apptools_preinit)!=null?_ref.deferred_core_modules:void 0)!=null){_ref2=window.__apptools_preinit.deferred_core_modules;for(_i=0,_len=_ref2.length;_i<_len;_i++)module=_ref2[_i],module.package!=null?this.sys.modules.install(module.module,module.package):this.sys.modules.install(module.module)}return this.sys.go()}return AppTools}(),window.AppTools=AppTools,window.apptools=new AppTools(window),window.jQuery!=null?$.extend({apptools:window.apptools}):(window.$=function(id){return document.getElementById(id)},window.$.apptools=window.apptools)}).call(this);